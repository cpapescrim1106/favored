// Favored - Polymarket Scanner + Bulk Trader + Portfolio Manager
// Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// MARKET DATA
// ============================================================================

enum Venue {
  POLYMARKET
  KALSHI
}

/// Polymarket market data (synced from Gamma API)
model Market {
  id        String    @id // Polymarket condition_id or Kalshi ticker
  venue     Venue     @default(POLYMARKET)
  slug      String
  eventSlug String?   // Parent event slug for Polymarket URL
  eventTicker String? // Parent event ticker for Kalshi
  question  String
  category  String?
  endDate   DateTime?
  active    Boolean   @default(true)

  // Latest snapshot
  yesPrice    Decimal?  @db.Decimal(10, 6)
  noPrice     Decimal?  @db.Decimal(10, 6)
  spread      Decimal?  @db.Decimal(10, 6)
  liquidity   Decimal?  @db.Decimal(18, 2)
  volume24h   Decimal?  @db.Decimal(18, 2)
  lastUpdated DateTime?

  // CLOB token IDs for orderbook access (YES token, NO token)
  clobTokenIds String[] @default([])

  // Kalshi tick structure (stored from market metadata)
  priceLevelStructure String?
  priceRanges         Json?

  // Relations
  candidates  Candidate[]
  basketItems BasketItem[]
  positions   Position[]
  marketMaker MarketMaker?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([category])
  @@index([endDate])
  @@unique([venue, slug])
  @@map("markets")
}

// ============================================================================
// SCANNING & CANDIDATES
// ============================================================================

/// Scored trading candidate from a scan
model Candidate {
  id       String @id @default(cuid())
  marketId String
  market   Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  side        String  // "YES" or "NO"
  outcomeName String? // Display name: "Rams", "Yes", "Trump", etc.
  impliedProb Decimal @db.Decimal(10, 6)
  score       Decimal @db.Decimal(10, 4)
  spreadOk    Boolean
  liquidityOk Boolean

  scanId    String // Links to scan batch
  scannedAt DateTime @default(now())

  @@index([scanId])
  @@index([scannedAt])
  @@index([score])
  @@map("candidates")
}

// ============================================================================
// BASKET & ORDERS
// ============================================================================

enum BasketStatus {
  DRAFT
  PENDING
  EXECUTING
  COMPLETED
  FAILED
  CANCELLED
}

/// Basket of orders to be executed together
model Basket {
  id         String       @id @default(cuid())
  status     BasketStatus @default(DRAFT)
  totalStake Decimal      @db.Decimal(18, 2)
  itemCount  Int
  batchCount Int // Number of order batches (max 15 per batch)

  items BasketItem[]

  createdAt  DateTime  @default(now())
  executedAt DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("baskets")
}

/// Individual item in a basket
model BasketItem {
  id       String @id @default(cuid())
  basketId String
  basket   Basket @relation(fields: [basketId], references: [id], onDelete: Cascade)
  marketId String
  market   Market @relation(fields: [marketId], references: [id], onDelete: Restrict)

  side          String // "YES" or "NO"
  stake         Decimal @db.Decimal(18, 2)
  limitPrice    Decimal @db.Decimal(10, 6)
  snapshotPrice Decimal @db.Decimal(10, 6) // Price at basket build

  // Execution results
  orderId    String?
  fillPrice  Decimal? @db.Decimal(10, 6)
  fillAmount Decimal? @db.Decimal(18, 2)
  status     String   @default("pending") // pending, submitted, filled, partial, failed, cancelled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([basketId])
  @@index([status])
  @@map("basket_items")
}

// ============================================================================
// POSITIONS & TRADES
// ============================================================================

enum PositionStatus {
  OPEN
  CLOSING
  CLOSED
  RESOLVED
}

/// Open or closed position
model Position {
  id       String @id @default(cuid())
  marketId String
  market   Market @relation(fields: [marketId], references: [id], onDelete: Restrict)

  side      String  @db.VarChar(3) // "YES" or "NO"
  size      Decimal @db.Decimal(18, 6) // Token amount
  avgEntry  Decimal @db.Decimal(10, 6)
  totalCost Decimal @db.Decimal(18, 2)

  // Current state (updated by reconciliation)
  markPrice     Decimal? @db.Decimal(10, 6)
  unrealizedPnl Decimal? @db.Decimal(18, 2)

  // Targets
  takeProfitPrice Decimal? @db.Decimal(10, 6)

  status   PositionStatus @default(OPEN)
  openedAt DateTime       @default(now())
  closedAt DateTime?

  trades Trade[]

  @@unique([marketId, side])
  @@index([status])
  @@index([openedAt])
  @@map("positions")
}

/// Individual trade (entry or exit)
model Trade {
  id         String   @id @default(cuid())
  positionId String
  position   Position @relation(fields: [positionId], references: [id], onDelete: Cascade)

  type    String // "ENTRY" or "EXIT"
  side    String // "BUY" or "SELL"
  price   Decimal @db.Decimal(10, 6)
  size    Decimal @db.Decimal(18, 6)
  value   Decimal @db.Decimal(18, 2)
  orderId String?
  fee     Decimal? @db.Decimal(18, 6)

  executedAt DateTime @default(now())

  @@index([positionId])
  @@index([executedAt])
  @@map("trades")
}

// ============================================================================
// MARKET MAKING
// ============================================================================

/// Market maker configuration and state for a single market
model MarketMaker {
  id       String @id @default(cuid())
  marketId String @unique
  market   Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  // Status
  active Boolean @default(true)
  paused Boolean @default(false)

  // Quote Parameters (in shares, not dollars)
  targetSpread  Decimal @db.Decimal(5, 4) // e.g., 0.02 = 2%
  orderSize     Decimal @db.Decimal(18, 6) // Shares per side
  maxInventory  Decimal @db.Decimal(18, 6) // Max shares exposure per outcome
  skewFactor    Decimal @db.Decimal(5, 4) // Max price shift at full inventory
  quotingPolicy String  @default("touch") // "touch", "inside", "back", "defensive", "offsets"
  bidOffsetTicks Int? // Ticks behind best bid (null = use policy)
  askOffsetTicks Int? // Ticks above best ask (null = use policy)

  // Dual-outcome inventory (in shares)
  yesInventory Decimal @default(0) @db.Decimal(18, 6) // YES token position
  noInventory  Decimal @default(0) @db.Decimal(18, 6) // NO token position

  // PnL tracking
  realizedPnl     Decimal @default(0) @db.Decimal(18, 6) // Realized profit/loss
  avgYesCost      Decimal @default(0) @db.Decimal(10, 6) // Avg cost basis for YES
  avgNoCost       Decimal @default(0) @db.Decimal(10, 6) // Avg cost basis for NO

  // Risk guardrails
  minTimeToResolution Int      @default(24) // Hours before market end to stop quoting
  volatilityPauseUntil DateTime? // Pause quoting until this time

  // Timestamps
  lastQuoteAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  orders       MarketMakerOrder[]
  fills        MarketMakerFill[]
  quoteHistory QuoteHistory[]

  @@index([active])
  @@map("market_makers")
}

/// Active orders for a market maker (supports tiered quoting with multiple orders per side)
model MarketMakerOrder {
  id            String      @id @default(cuid())
  marketMakerId String
  marketMaker   MarketMaker @relation(fields: [marketMakerId], references: [id], onDelete: Cascade)

  outcome String // "YES" or "NO"
  side    String // "BID" or "ASK"
  tier    Int    @default(0) // Tier level: 0 = closest to mid, 1 = next level, etc.
  orderId String // CLOB order ID
  clientOrderId String?
  orderGroupId  String?
  tokenId String // Token ID for this outcome
  price   Decimal @db.Decimal(10, 6)
  size    Decimal @db.Decimal(18, 6) // Shares
  lastMatchedSize Decimal? @db.Decimal(18, 6) // Tracks cumulative matched size for partial fills
  verified Boolean @default(true) // False if post-placement verification failed (pending reconciliation)

  placedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketMakerId, outcome, side, tier])
  @@index([orderId])
  @@index([marketMakerId, outcome, side])
  @@map("market_maker_orders")
}

/// Fill records for PnL tracking (FIFO/avg-cost)
model MarketMakerFill {
  id            String      @id @default(cuid())
  marketMakerId String
  marketMaker   MarketMaker @relation(fields: [marketMakerId], references: [id], onDelete: Cascade)

  outcome    String // "YES" or "NO"
  side       String // "BUY" or "SELL"
  orderId    String // CLOB order ID that was filled
  clientOrderId String?
  price      Decimal @db.Decimal(10, 6)
  size       Decimal @db.Decimal(18, 6) // Shares filled
  value      Decimal @db.Decimal(18, 6) // price * size
  fee        Decimal @default(0) @db.Decimal(18, 6)
  realizedPnl Decimal? @db.Decimal(18, 6) // PnL realized from this fill (for sells)

  filledAt DateTime @default(now())

  @@index([marketMakerId])
  @@index([filledAt])
  @@map("market_maker_fills")
}

/// Audit trail of quote updates and state changes
model QuoteHistory {
  id            String      @id @default(cuid())
  marketMakerId String
  marketMaker   MarketMaker @relation(fields: [marketMakerId], references: [id], onDelete: Cascade)

  action   String // "QUOTE_PLACED", "QUOTE_UPDATED", "QUOTE_CANCELLED", "FILL", "PAUSE", "RESUME", "ERROR"
  outcome  String? // "YES" or "NO"
  side     String? // "BID" or "ASK"
  price    Decimal? @db.Decimal(10, 6)
  size     Decimal? @db.Decimal(18, 6)
  orderId  String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([marketMakerId])
  @@index([createdAt])
  @@map("quote_history")
}

// ============================================================================
// LOGGING
// ============================================================================

/// Audit log entry
model Log {
  id       String @id @default(cuid())
  level    String // "INFO", "WARN", "ERROR"
  category String // "SCAN", "BASKET", "ORDER", "RECONCILE", "EXIT", "SYSTEM"
  message  String
  metadata Json? // Additional context (redacted of sensitive data)

  createdAt DateTime @default(now())

  @@index([category])
  @@index([level])
  @@index([createdAt])
  @@map("logs")
}

// ============================================================================
// CONFIGURATION
// ============================================================================

/// Singleton configuration
model Config {
  id String @id @default("singleton")

  // Probability band
  minProb Decimal @default(0.65) @db.Decimal(5, 4)
  maxProb Decimal @default(0.90) @db.Decimal(5, 4)

  // Spread/liquidity gates
  maxSpread    Decimal @default(0.03) @db.Decimal(5, 4) // 3%
  minLiquidity Decimal @default(5000) @db.Decimal(18, 2)

  // Sizing
  defaultStake      Decimal @default(50) @db.Decimal(18, 2)
  maxStakePerMarket Decimal @default(200) @db.Decimal(18, 2)

  // Exposure caps
  maxExposurePerMarket   Decimal @default(500) @db.Decimal(18, 2)
  maxExposurePerCategory Decimal @default(2000) @db.Decimal(18, 2)
  maxOpenPositions       Int     @default(50)
  maxTotalExposure       Decimal @default(10000) @db.Decimal(18, 2)

  // Take profit
  takeProfitThreshold Decimal @default(0.95) @db.Decimal(5, 4)

  // Slippage guard
  maxSlippage Decimal @default(0.02) @db.Decimal(5, 4) // 2%

  // Kill switch
  killSwitchActive Boolean @default(false)

  // Scan settings
  scanInterval Int @default(10) // minutes

  // Exclusions (categories to skip, e.g., ["crypto"])
  excludedCategories String[] @default([])

  // Market Making defaults (sizes in shares)
  mmDefaultSpread         Decimal @default(0.04) @db.Decimal(5, 4) // 4%
  mmDefaultOrderSize      Decimal @default(100) @db.Decimal(18, 6) // Shares per side
  mmDefaultMaxInventory   Decimal @default(500) @db.Decimal(18, 6) // Max shares per outcome
  mmDefaultSkewFactor     Decimal @default(0.04) @db.Decimal(5, 4) // Max price shift at full inv
  mmDefaultQuotingPolicy  String  @default("touch") // "touch", "inside", "back", "tiered"
  mmRefreshThreshold      Decimal @default(0.01) @db.Decimal(5, 4) // 1% price move triggers refresh
  mmMinTimeToResolution   Int     @default(24) // Hours before end to stop quoting
  mmEnabled               Boolean @default(false) // Global MM kill switch

  // Tiered quoting config (global defaults for "tiered" policy)
  mmTierCount      Int    @default(2) // Number of price levels per side
  mmTierBidOffsets String @default("1,2") // Cents behind best bid (comma-separated)
  mmTierAskOffsets String @default("0,1") // Cents behind best ask (comma-separated)
  mmTierSizes      String @default("0.5,0.5") // Size % per tier (comma-separated)

  updatedAt DateTime @updatedAt

  @@map("config")
}
